{% set ethernet = (l2vpn_terminations.json.results | selectattr("assigned_object.name", "search", "^ethernet") | map(attribute="assigned_object.name") | list | first) %}
{% set vxlan = (l2vpn_terminations.json.results | selectattr("assigned_object.name", "search", "^vxlan") | map(attribute="assigned_object.name") | list | first) %}
{% set ibgp_asn = (asns.json.results | selectattr("description", "search", "ibgp overlay leirt") | map(attribute="asn") | list | first) %}
{
  "network-instance": [
    {
      "name": "default",
      "protocols": {
        "bgp": {
          "group": [
            {
              "group-name": "ibgp-overlay",
              "peer-as": "{{ ibgp_asn }}",
              "afi-safi": [
                {
                  "afi-safi-name": "ipv4-unicast",
                  "admin-state": "disable"
                },
                {
                  "afi-safi-name": "evpn",
                  "admin-state": "enable"
                }
              ],
              "timers": {
                "minimum-advertisement-interval": "1"
              },
              "local-as": {
                "as-number": "{{ ibgp_asn }}"
              }
            }
          ],
          "neighbor": [
            {% for device in all_devices.json.results if device.role.display == "spine" %}
            {
              "peer-address": "{{device.custom_fields.Router_ID}}",
              "peer-group": "ibgp-overlay",
              "transport": {
                "local-address": "{{ devices.json.results[0].custom_fields.Router_ID }}"
              }
            }{% if not loop.last %},{% endif %}
            {% endfor %}
            
          ]
        }
      }
    },
    {
      "name": "{{vrfs.json.results[0].display}}",
      "type": "mac-vrf",
      "admin-state": "enable",
      "interface": [
        {
          "name": "{{ethernet}}.0"
        }
      ],
      "vxlan-interface": [
        {
          "name": "{{vxlan}}.1"
        }
      ],
      "protocols": {
        "bgp-evpn": {
          "bgp-instance": [
            {
              "id": 1,
              "admin-state": "enable",
              "vxlan-interface": "{{vxlan}}.1",
              "evi": {{l2vpns.json.results[0].identifier}}
            }
          ]
        },
        "bgp-vpn": {
          "bgp-instance": [
            {
              "id": 1,
              "route-target": {
                "export-rt": "target:{{vrfs.json.results[0].export_targets[0].display}}",
                "import-rt": "target:{{vrfs.json.results[0].import_targets[0].display}}"
              }
            }
          ]
        }
      }
    }
  ],
  "interface": [
    {
      "name": "{{ethernet}}",
      "vlan-tagging": true,
      "subinterface": [
        {
          "index": 0,
          "type": "bridged",
          "admin-state": "enable",
          "vlan": {
            "encap": {
              "untagged": {}
            }
          }
        }
      ]
    }
  ],
  "tunnel-interface": [
    {
      "name": "{{vxlan}}",
      "vxlan-interface": [
        {
          "index": 1,
          "type": "bridged",
          "ingress": {
            "vni": {{vlans.json.results[0].vid}}
          }
        }
      ]
    }
  ]
}
